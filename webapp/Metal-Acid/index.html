<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemSim Pro - Â§öÈáëÂ±û‰∫§‰∫íÁâà</title>
    <style>
        /* ====================
           STYLE.CSS 
           ==================== */
        :root {
            --bg-color: #050505;
            --panel-bg: #141414;
            --primary: #4facfe;
            --secondary: #00f2fe;
            --text-main: #f0f0f0;
            --text-muted: #888;
            --card-border: #333;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* È°∂ÈÉ®ÂØºËà™ */
        header {
            height: 50px;
            background: #0f1012;
            border-bottom: 1px solid #222;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
        }
        h1 { font-size: 1.1rem; letter-spacing: 1px; color: var(--primary); font-weight: 800; text-transform: uppercase; }

        .btn {
            background: #222; color: #ccc; border: 1px solid #444;
            padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;
            transition: 0.2s;
        }
        .btn:hover { border-color: var(--primary); color: #fff; background: #333; }
        .btn-primary { background: var(--primary); color: #000; border: none; font-weight: bold; }
        .btn-primary:hover { background: var(--secondary); }

        /* ‰∏ªÂ∏ÉÂ±Ä */
        main {
            flex: 1;
            display: grid;
            grid-template-columns: 360px 1fr 300px; 
            overflow: hidden;
        }

        /* --- Â∑¶‰æßÔºöËçØÂìÅÂå∫ --- */
        #inventory {
            background: var(--panel-bg);
            border-right: 1px solid #222;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .group-label {
            font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        /* Âç°ÁâáËÆæËÆ° */
        .chem-card {
            background: #1e1e1e;
            border: 1px solid var(--card-border);
            border-radius: 4px;
            height: 70px;
            position: relative;
            cursor: grab;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 6px;
            user-select: none;
            overflow: hidden;
        }

        .chem-card:hover {
            background: #252525;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 2;
        }
        
        .chem-card:active { cursor: grabbing; }

        .card-tag { font-size: 0.5rem; color: #555; position: absolute; top: 4px; left: 4px; }

        .card-formula {
            position: absolute;
            top: 2px;
            right: 4px;
            font-family: 'Arial', sans-serif;
            font-weight: 900;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .card-icon {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 1.2rem;
            opacity: 0.2;
        }

        .card-name {
            font-size: 0.75rem;
            color: #ccc;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
        }

        .color-indicator {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            opacity: 0.8;
        }

        /* --- ‰∏≠Èó¥ÔºöËØïÁÆ°Êû∂ --- */
        #rack-area {
            background: radial-gradient(circle at bottom, #1b1b1b, #000);
            position: relative;
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding: 0 40px;
        }

        #rack-shelf {
            position: absolute; bottom: 100px; left: 0; width: 100%; height: 10px;
            background: #333; border-top: 1px solid #555; box-shadow: 0 10px 20px rgba(0,0,0,0.8);
        }

        .tube-container {
            position: relative;
            width: 80px; height: 320px;
            margin: 0 20px;
            flex-shrink: 0;
            z-index: 5;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
        }

        .test-tube {
            width: 40px; height: 250px;
            border: 2px solid rgba(255,255,255,0.2); border-top: none;
            border-radius: 0 0 20px 20px;
            background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.1) 30%, rgba(255,255,255,0.02));
            position: relative;
            overflow: hidden;
            transition: box-shadow 0.3s;
        }
        
        .test-tube.highlight { border-color: var(--primary); box-shadow: 0 0 20px rgba(79, 172, 254, 0.3); }

        .liquid {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: rgba(255,255,255,0.05);
            transition: height 1s ease-out, background-color 1s ease;
            z-index: 1;
        }

        /* Âõ∫‰ΩìÊ†∑Âºè */
        .solid {
            width: 14px; height: 14px;
            position: absolute; bottom: 10px; 
            /* left Áî±JSÂä®ÊÄÅÈöèÊú∫ÊéßÂà∂Ôºå‰∏çÂÜçÂõ∫ÂÆö50% */
            border-radius: 2px;
            z-index: 2;
            box-shadow: inset 1px 1px 2px rgba(255,255,255,0.5), 1px 1px 3px rgba(0,0,0,0.8);
            transition: all 0.5s;
        }
        .solid[data-type="Fe"] { height: 25px; width: 6px; border-radius: 1px; }
        .solid[data-type="Cu"] { width: 18px; height: 4px; border-radius: 2px; transform: rotate(45deg); bottom: 12px; }

        .tube-label {
            margin-top: 15px; font-family: monospace; font-size: 0.8rem; color: #555;
            background: #111; padding: 2px 5px; border-radius: 3px;
        }

        .btn-close {
            position: absolute; top: -30px; color: #ff5252; cursor: pointer; font-weight: bold;
            background: rgba(255,0,0,0.1); width: 20px; height: 20px; text-align: center; line-height: 20px; border-radius: 50%;
            opacity: 0; transition: 0.2s;
        }
        .tube-container:hover .btn-close { opacity: 1; top: 0; }

        /* Ê∞îÊ≥° */
        .bubble {
            position: absolute; 
            background: rgba(255,255,255,0.6); 
            border-radius: 50%;
            pointer-events: none; 
            z-index: 3;
            bottom: 15px;
            /* left Áî±JSÊ†πÊçÆÂõ∫‰Ωì‰ΩçÁΩÆÊéßÂà∂ */
            animation: bubbleRise linear forwards;
        }
        
        @keyframes bubbleRise { 
            0% { transform: translate(var(--x), 0) scale(0.5); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translate(var(--x), -150px) scale(1.2); opacity: 0; } 
        }

        /* --- Âè≥‰æßÔºöÊï∞ÊçÆÂ±è --- */
        #info {
            background: var(--panel-bg);
            border-left: 1px solid #222;
            display: flex; flex-direction: column;
        }

        .monitor-screen {
            background: #000; padding: 25px;
            border-bottom: 2px solid #333;
            min-height: 120px;
            display: flex; flex-direction: column; justify-content: center;
        }
        
        /* ÊñπÁ®ãÂºèÊòæÁ§∫Âå∫Âüü */
        .eq-text { 
            color: #ff6b6b; 
            font-family: 'Segoe UI', sans-serif; 
            font-size: 1.2rem; 
            font-weight: bold; 
            margin: 10px 0; 
            line-height: 1.4; 
        }
        
        .status-text { color: #888; font-size: 0.85rem; margin-top: 5px; }
        .info-title { color: var(--primary); font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase; }

        .log-container { flex: 1; overflow-y: auto; padding: 20px; }
        .log-item { margin-bottom: 10px; font-size: 0.85rem; color: #bbb; border-left: 2px solid #333; padding-left: 10px; line-height: 1.4; }

    </style>
</head>
<body>

<header>
    <h1>ChemSim Pro</h1>
    <div>
        <button class="btn btn-primary" onclick="lab.addTube()">+ Ê∑ªÂä†ËØïÁÆ°</button>
        <button class="btn" onclick="lab.reset()">‚ôª ÈáçÁΩÆ</button>
    </div>
</header>

<main>
    <!-- ËçØÂìÅÊ†è -->
    <aside id="inventory">
        <div class="group-label">ÈÖ∏Ê∫∂Ê∂≤ / Acid</div>
        <div class="item-grid" id="acids-grid"></div>
        
        <div class="group-label">ÁõêÊ∫∂Ê∂≤ / Salt</div>
        <div class="item-grid" id="salts-grid"></div>

        <div class="group-label">ÈáëÂ±ûÂçïË¥® / Metal</div>
        <div class="item-grid" id="metals-grid"></div>
    </aside>

    <!-- ÂÆûÈ™åÂè∞ -->
    <section id="rack-area">
        <div id="rack-shelf"></div>
    </section>

    <!-- ÊòæÁ§∫Â±è -->
    <aside id="info">
        <div class="monitor-screen">
            <div class="info-title">REACTION MONITOR</div>
            <div class="eq-text" id="display-eq">SYSTEM READY</div>
            <div class="status-text" id="display-status">‰ªªÊÑèÈ°∫Â∫èÊãñÂÖ•ËçØÂìÅÔºåÊîØÊåÅÂ§öÈáëÂ±û</div>
        </div>
        <div class="log-container" id="logs"></div>
    </aside>
</main>

<script>
    /**
     * ÈÖçÁΩÆÊï∞ÊçÆ
     */
    const SOLUTIONS = {
        'HCl': { name: 'Á®ÄÁõêÈÖ∏', formula: 'HCl', type: 'acid', color: 'rgba(255,255,255,0.05)', theme: '#fff' },
        'H2SO4': { name: 'Á®ÄÁ°´ÈÖ∏', formula: 'H‚ÇÇSO‚ÇÑ', type: 'acid', color: 'rgba(255,255,255,0.05)', theme: '#fff' },
        'CH3COOH': { name: 'ÈÜãÈÖ∏', formula: 'CH‚ÇÉCOOH', type: 'acid', color: 'rgba(255,255,255,0.05)', theme: '#fff' },
        'CuSO4': { name: 'Á°´ÈÖ∏Èìú', formula: 'CuSO‚ÇÑ', type: 'salt', color: 'rgba(0, 119, 190, 0.6)', theme: '#0077be' },
        'AgNO3': { name: 'Á°ùÈÖ∏Èì∂', formula: 'AgNO‚ÇÉ', type: 'salt', color: 'rgba(255,255,255,0.05)', theme: '#fff' },
        'FeSO4': { name: 'Á°´ÈÖ∏‰∫öÈìÅ', formula: 'FeSO‚ÇÑ', type: 'salt', color: 'rgba(119, 221, 119, 0.3)', theme: '#77dd77' },

        // ÊΩúÂú®‰∫ßÁâ©
        'MgCl2': { name: 'Ê∞ØÂåñÈïÅ', formula: 'MgCl‚ÇÇ', color: 'rgba(255,255,255,0.05)' },
        'ZnCl2': { name: 'Ê∞ØÂåñÈîå', formula: 'ZnCl‚ÇÇ', color: 'rgba(255,255,255,0.05)' },
        'FeCl2': { name: 'Ê∞ØÂåñ‰∫öÈìÅ', formula: 'FeCl‚ÇÇ', color: 'rgba(119, 221, 119, 0.3)' }, 
        'MgSO4': { name: 'Á°´ÈÖ∏ÈïÅ', formula: 'MgSO‚ÇÑ', color: 'rgba(255,255,255,0.05)' },
        'ZnSO4': { name: 'Á°´ÈÖ∏Èîå', formula: 'ZnSO‚ÇÑ', color: 'rgba(255,255,255,0.05)' },
    };

    const METALS = {
        'Mg': { name: 'ÈïÅÂ∏¶', formula: 'Mg', color: '#f5f5f5' }, 
        'Zn': { name: 'ÈîåÁ≤í', formula: 'Zn', color: '#90a4ae' }, 
        'Fe': { name: 'ÈìÅÈíâ', formula: 'Fe', color: '#bdc3c7' }, 
        'Cu': { name: 'Èìú‰∏ù', formula: 'Cu', color: '#d35400' }, 
        'Ag': { name: 'Èì∂‰∏ù', formula: 'Ag', color: '#ffffff' } 
    };

    const REACTIONS = {
        'Mg_HCl': { next: 'MgCl2', bubble: 'fast', dissolve: true, time: 4000, eq: 'Mg + 2HCl ‚Üí MgCl‚ÇÇ + H‚ÇÇ‚Üë' },
        'Mg_H2SO4': { next: 'MgSO4', bubble: 'fast', dissolve: true, time: 4000, eq: 'Mg + H‚ÇÇSO‚ÇÑ ‚Üí MgSO‚ÇÑ + H‚ÇÇ‚Üë' },
        'Mg_CuSO4': { next: 'MgSO4', solid: '#d35400', time: 2000, eq: 'Mg + CuSO‚ÇÑ ‚Üí MgSO‚ÇÑ + Cu' }, 
        'Mg_FeSO4': { next: 'MgSO4', solid: '#424242', time: 2000, eq: 'Mg + FeSO‚ÇÑ ‚Üí MgSO‚ÇÑ + Fe' },

        'Zn_HCl': { next: 'ZnCl2', bubble: 'med', dissolve: true, time: 6000, eq: 'Zn + 2HCl ‚Üí ZnCl‚ÇÇ + H‚ÇÇ‚Üë' },
        'Zn_H2SO4': { next: 'ZnSO4', bubble: 'med', dissolve: true, time: 6000, eq: 'Zn + H‚ÇÇSO‚ÇÑ ‚Üí ZnSO‚ÇÑ + H‚ÇÇ‚Üë' },
        'Zn_CuSO4': { next: 'ZnSO4', solid: '#d35400', time: 2000, eq: 'Zn + CuSO‚ÇÑ ‚Üí ZnSO‚ÇÑ + Cu' },

        'Fe_HCl': { next: 'FeCl2', bubble: 'slow', dissolve: true, time: 10000, eq: 'Fe + 2HCl ‚Üí FeCl‚ÇÇ + H‚ÇÇ‚Üë' },
        'Fe_H2SO4': { next: 'FeSO4', bubble: 'slow', dissolve: true, time: 10000, eq: 'Fe + H‚ÇÇSO‚ÇÑ ‚Üí FeSO‚ÇÑ + H‚ÇÇ‚Üë' },
        'Fe_CuSO4': { next: 'FeSO4', solid: '#d35400', time: 5000, eq: 'Fe + CuSO‚ÇÑ ‚Üí FeSO‚ÇÑ + Cu' }, 
        'Fe_AgNO3': { next: 'FeSO4', solid: '#ececec', time: 5000, eq: 'Fe + 2AgNO‚ÇÉ ‚Üí Fe(NO‚ÇÉ)‚ÇÇ + 2Ag' },

        'Cu_AgNO3': { next: 'CuSO4', solid: '#ececec', time: 5000, eq: 'Cu + 2AgNO‚ÇÉ ‚Üí Cu(NO‚ÇÉ)‚ÇÇ + 2Ag' }
    };

    class Laboratory {
        constructor() {
            this.tubeIdCounter = 0;
            this.tubes = {}; 
            this.dragItem = null;
            this.initUI();
        }

        initUI() {
            if(document.getElementById('acids-grid').children.length === 0) {
                this.renderGroup(['HCl', 'H2SO4', 'CH3COOH'], 'acids-grid');
                this.renderGroup(['CuSO4', 'AgNO3', 'FeSO4'], 'salts-grid');
                this.renderGroup(['Mg', 'Zn', 'Fe', 'Cu', 'Ag'], 'metals-grid', true);
            }
            this.addTube();
            this.addTube();
        }

        renderGroup(ids, containerId, isMetal = false) {
            const container = document.getElementById(containerId);
            ids.forEach(id => {
                const data = isMetal ? METALS[id] : SOLUTIONS[id];
                const div = document.createElement('div');
                div.className = 'chem-card';
                div.draggable = true;
                
                const colorBar = isMetal ? data.color : data.theme;
                div.innerHTML = `
                    <div class="color-indicator" style="background:${colorBar}"></div>
                    <div class="card-tag">${isMetal ? 'M' : 'Aq'}</div>
                    <div class="card-formula">${data.formula}</div>
                    <div class="card-icon">${isMetal ? '‚öôÔ∏è' : 'üß™'}</div>
                    <div class="card-name">${data.name}</div>
                `;

                div.addEventListener('dragstart', (e) => {
                    this.dragItem = { id, type: isMetal ? 'metal' : 'sol' };
                    div.style.opacity = '0.5';
                });
                div.addEventListener('dragend', () => div.style.opacity = '1');
                container.appendChild(div);
            });
        }

        addTube() {
            this.tubeIdCounter++;
            const tid = this.tubeIdCounter;
            // metals Âèò‰∏∫Êï∞ÁªÑÔºåÁßªÈô§ reacting ÈîÅ‰ª•ÂÖÅËÆ∏Âπ∂Ë°åÊìç‰Ωú
            this.tubes[tid] = { sol: null, metals: [] };

            const div = document.createElement('div');
            div.className = 'tube-container';
            div.id = `tube-${tid}`;
            div.innerHTML = `
                <div class="btn-close" onclick="lab.removeTube(${tid})">√ó</div>
                <div class="test-tube">
                    <div class="liquid"></div>
                </div>
                <div class="tube-label">No.${tid}</div>
            `;

            const tubeEl = div.querySelector('.test-tube');
            
            tubeEl.addEventListener('dragover', (e) => { e.preventDefault(); tubeEl.classList.add('highlight'); });
            tubeEl.addEventListener('dragleave', () => tubeEl.classList.remove('highlight'));
            tubeEl.addEventListener('drop', (e) => {
                e.preventDefault();
                tubeEl.classList.remove('highlight');
                this.handleDrop(tid);
            });

            document.getElementById('rack-shelf').after(div);
        }

        removeTube(id) {
            const el = document.getElementById(`tube-${id}`);
            if(el) el.remove();
            const state = this.tubes[id];
            // Ê∏ÖÁêÜÂèØËÉΩÂ≠òÂú®ÁöÑÂ§ö‰∏™ËÆ°Êó∂Âô®
            if(state && state.metals) {
                state.metals.forEach(m => {
                    if(m.timer) clearInterval(m.timer);
                });
            }
            delete this.tubes[id];
        }

        handleDrop(tid) {
            if (!this.dragItem) return;
            const { id, type } = this.dragItem;
            const state = this.tubes[tid];

            // 1. ÊãñÂÖ•Ê∫∂Ê∂≤
            if (type === 'sol') {
                if (state.sol) return this.log(`ËØïÁÆ° ${tid} Â∑≤ÊúâÊ∫∂Ê∂≤„ÄÇ`);
                
                this.fillLiquid(tid, id);
                
                // ÈÅçÂéÜÂΩìÂâçÊâÄÊúâÈáëÂ±ûÔºåÂÖ®ÈÉ®Ëß¶ÂèëÊ£ÄÊü•
                if (state.metals.length > 0) {
                    state.metals.forEach(m => {
                        this.checkReaction(tid, m.id, id, m.el);
                    });
                }
            } 
            // 2. ÊãñÂÖ•ÈáëÂ±û (ÂÖÅËÆ∏Êó†ÈôêÂè†Âä†)
            else {
                // ‰∏çÂÜçÊ£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÈáëÂ±û
                this.addSolid(tid, id);
                
                // Â¶ÇÊûúÂ∑≤ÊúâÊ∫∂Ê∂≤ÔºåÁ´ãÂç≥Ëß¶ÂèëËøô‰∏™Êñ∞ÈáëÂ±ûÁöÑÂèçÂ∫î
                if (state.sol) {
                    // Ëé∑ÂèñÂàöÂä†ËøõÂéªÁöÑÈÇ£‰∏™ÈáëÂ±ûÔºàÊï∞ÁªÑÊúÄÂêé‰∏Ä‰∏™Ôºâ
                    const lastMetal = state.metals[state.metals.length - 1];
                    this.checkReaction(tid, id, state.sol, lastMetal.el);
                }
            }
        }

        fillLiquid(tid, solId) {
            const sol = SOLUTIONS[solId];
            this.tubes[tid].sol = solId;
            const liq = document.getElementById(`tube-${tid}`).querySelector('.liquid');
            liq.style.height = '60%'; 
            liq.style.backgroundColor = sol.color;
            this.updateScreen('Â∑≤Ê∑ªÂä†Ê∫∂Ê∂≤', `Âä†ÂÖ• ${sol.formula}`, '#4facfe');
        }

        addSolid(tid, metalId) {
            const metal = METALS[metalId];
            const tubeEl = document.getElementById(`tube-${tid}`).querySelector('.test-tube');
            
            const solid = document.createElement('div');
            solid.className = 'solid';
            solid.dataset.type = metalId;
            solid.style.backgroundColor = metal.color;
            
            // ÈöèÊú∫Ê∞¥Âπ≥‰ΩçÁΩÆÔºåÈò≤Ê≠¢ÂÆåÂÖ®ÈáçÂè†
            const randomLeft = 50 + (Math.random() * 40 - 20); // 30% - 70%
            solid.style.left = randomLeft + '%';
            
            tubeEl.appendChild(solid);
            
            // Êé®ÂÖ•Êï∞ÁªÑ
            this.tubes[tid].metals.push({ id: metalId, el: solid, timer: null });
            
            this.updateScreen('Â∑≤Ê∑ªÂä†ÈáëÂ±û', `Âä†ÂÖ• ${metal.formula}`, '#ccc');
        }

        // ËøôÈáåÁöÑ checkReaction Êé•Êî∂ÂÖ∑‰ΩìÁöÑ solidEl DOMÂÖÉÁ¥†
        checkReaction(tid, mId, sId, solidEl) {
            const key = `${mId}_${sId}`;
            const res = REACTIONS[key];

            if (res) {
                this.runReaction(tid, res, solidEl);
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÂèçÂ∫îÔºåÂè™Âú®Êó•ÂøóËÆ∞ÂΩï‰∏Ä‰∏ãÔºå‰∏çÂà∑Â±èÊòæÁ§∫
                this.log(`ËØïÁÆ° ${tid}: ${mId} Êó†ÂèçÂ∫î`);
            }
        }

        runReaction(tid, res, solidEl) {
            // ÊâæÂà∞ÂØπÂ∫îÁöÑÈáëÂ±ûÂØπË±°Êù•Â≠ò timer
            const state = this.tubes[tid];
            const metalObj = state.metals.find(m => m.el === solidEl);
            
            this.updateScreen('ÂèçÂ∫îËøõË°å‰∏≠...', res.eq, '#ff6b6b');
            this.log(`ËØïÁÆ° ${tid}: ÂèçÂ∫îÂºÄÂßã ${res.eq}`); 

            // Ê∞îÊ≥°Âä®Áîª
            if (res.bubble) {
                const interval = res.bubble === 'fast' ? 100 : 400;
                if(metalObj) {
                    metalObj.timer = setInterval(() => this.spawnBubble(tid, solidEl), interval);
                }
            }

            // Ê∫∂Ëß£Âä®Áîª
            if (res.dissolve) {
                solidEl.style.transition = `transform ${res.time}ms linear, opacity ${res.time}ms ease`;
                solidEl.style.transform = 'scale(0.1) rotate(10deg)'; // Á®çÂæÆÊóãËΩ¨
                // ËøôÈáå‰∏çÂÜçÁî® translateX(-50%) Âõ†‰∏∫ left Â∑≤ÁªèÊòØÈöèÊú∫ÂÆö‰Ωç‰∫Ü
                solidEl.style.opacity = '0.2';
            }

            setTimeout(() => {
                if(metalObj && metalObj.timer) clearInterval(metalObj.timer);

                // Êõ¥Êñ∞Ê∫∂Ê∂≤ (ÊúÄÂêéÂÆåÊàêÁöÑÂèçÂ∫îÂÜ≥ÂÆöÊúÄÁªàÈ¢úËâ≤ÔºåÁÆÄÂçïÊ®°Êãü)
                if (res.next) {
                    state.sol = res.next;
                    const nextSol = SOLUTIONS[res.next];
                    const liq = document.getElementById(`tube-${tid}`).querySelector('.liquid');
                    if(liq) liq.style.backgroundColor = nextSol.color;
                    // Êó•ÂøóÈò≤Ê≠¢Âà∑Â±èÔºåÂè™ÊòæÁ§∫ÂèòÂåñ
                    this.log(`ËØïÁÆ° ${tid}: Ê∫∂Ê∂≤Âèò‰∏∫ ${nextSol.name}`);
                }

                // Âõ∫‰ΩìÂèòÂåñÂ§ÑÁêÜ
                if (res.solid) {
                    solidEl.style.backgroundColor = res.solid;
                    solidEl.style.boxShadow = 'inset 0 0 5px rgba(0,0,0,0.8)';
                } else if (res.dissolve) {
                    solidEl.remove();
                    // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§ËØ•ÈáëÂ±û
                    state.metals = state.metals.filter(m => m.el !== solidEl);
                }

                this.updateScreen('ÂèçÂ∫îÁªìÊùüÔºö‰∫ßÁâ©Â∑≤ÁîüÊàê', res.eq, '#4caf50'); 

            }, res.time);
        }

        spawnBubble(tid, solidEl) {
            const tube = document.getElementById(`tube-${tid}`).querySelector('.test-tube');
            if(!tube || !solidEl) return;
            
            const b = document.createElement('div');
            b.className = 'bubble';
            const size = Math.random() * 4 + 2;
            b.style.width = size + 'px'; b.style.height = size + 'px';
            
            // Ê∞îÊ≥°‰ªéÈáëÂ±ûÂΩìÂâçÁöÑ left ‰ΩçÁΩÆÂçáËµ∑
            // Ëé∑Âèñ solidEl ÁöÑ style.left (‰æãÂ¶Ç "45%")
            // ËøôÈáåÁöÑ var(--x) ÊòØÁõ∏ÂØπËá™Ë∫´ÂÅèÁßªÔºåÊàë‰ª¨ÂèØ‰ª•‰øùÊåÅÁÆÄÂçïÈöèÊú∫ÂÅèÁßª
            const offset = (Math.random() * 10 - 5);
            b.style.left = solidEl.style.left; 
            
            b.style.setProperty('--x', offset + 'px');
            b.style.animationDuration = (Math.random() * 1 + 1) + 's';
            
            tube.appendChild(b);
            setTimeout(() => b.remove(), 2000);
        }

        updateScreen(status, text, color) {
            document.getElementById('display-status').innerText = status;
            const eq = document.getElementById('display-eq');
            eq.innerText = text;
            eq.style.color = color;
        }

        log(msg) {
            const div = document.createElement('div');
            div.className = 'log-item';
            div.innerText = msg;
            document.getElementById('logs').prepend(div);
        }

        reset() {
            document.querySelectorAll('.tube-container').forEach(e => e.remove());
            this.tubes = {};
            this.log('--- Á≥ªÁªüÂ∑≤ÈáçÁΩÆ ---');
            this.addTube();
            this.addTube();
        }
    }

    const lab = new Laboratory();

</script>
</body>
</html>