<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©ç†ä¸ç‰©ç†ï¼šå…¨åŠŸèƒ½å£°éŸ³å®éªŒå®¤</title>
    <style>
        :root {
            --calc-color: #ff5722;
            --piano-color: #1976d2;
            --bg-color: #fafafa;
            --text-color: #333;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding-bottom: 50px; }
        
        /* å¯åŠ¨é®ç½© */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        #start-btn {
            padding: 15px 40px; font-size: 24px; background: var(--piano-color); color: white;
            border: none; border-radius: 50px; cursor: pointer; margin-top: 20px;
            box-shadow: 0 0 20px rgba(25, 118, 210, 0.5); animation: pulse 1.5s infinite;
        }
        
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; margin-top: 40px; }
        h2 { border-left: 5px solid #333; padding-left: 15px; margin-top: 50px; }
        
        /* é€šç”¨å¯è§†åŒ–ç”»å¸ƒ */
        canvas { width: 100%; height: 150px; background: #222; border-radius: 8px; margin-top: 10px; display: block;}
        
        /* 1. è®¡ç®—å™¨æ ·å¼ */
        .calc-wrapper { background: #eee; padding: 20px; border-radius: 10px; border: 2px solid #ccc; max-width: 400px; margin: 20px auto; }
        .calc-screen { 
            background: #9ea7a0; padding: 15px; font-family: 'Courier New', monospace; 
            font-size: 24px; text-align: right; margin-bottom: 15px; border-radius: 4px; border: 2px solid #777;
        }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .btn-calc {
            padding: 15px 0; background: #fff; border: 1px solid #999; border-radius: 4px;
            font-size: 18px; cursor: pointer; box-shadow: 0 3px 0 #777; transition: transform 0.1s;
        }
        .btn-calc:active, .btn-calc.active { transform: translateY(3px); box-shadow: none; background: #ffccbc; }
        .btn-orange { background: var(--calc-color); color: white; border-color: #d84315; box-shadow: 0 3px 0 #bf360c; }

        /* 2. é’¢ç´æ ·å¼ */
        .piano-wrapper { display: flex; justify-content: center; margin: 20px 0; position: relative; height: 160px; }
        .key { 
            width: 40px; height: 160px; background: white; border: 1px solid #bbb; 
            border-radius: 0 0 4px 4px; cursor: pointer; z-index: 1; position: relative;
            display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px; font-size: 12px; color: #999;
        }
        .key.black { 
            background: #333; color: white; height: 100px; width: 30px; 
            margin: 0 -15px; z-index: 2; border: 1px solid #000;
        }
        .key:active, .key.active { background: #ddd; transform: scaleY(0.98); transform-origin: top; }
        .key.black:active, .key.black.active { background: #000; }

        /* 3. å‚…é‡Œå¶åˆ†ææ ·å¼ */
        .fourier-controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; }
        .f-btn {
            padding: 10px 20px; border: 2px solid transparent; cursor: pointer; font-weight: bold; border-radius: 4px;
        }
        .f-btn.calc-mode { border-color: var(--calc-color); color: var(--calc-color); background: white; }
        .f-btn.calc-mode.active { background: var(--calc-color); color: white; }
        .f-btn.piano-mode { border-color: var(--piano-color); color: var(--piano-color); background: white; }
        .f-btn.piano-mode.active { background: var(--piano-color); color: white; }

        .analysis-box { display: flex; gap: 10px; flex-wrap: wrap; }
        .analysis-col { flex: 1; min-width: 300px; }
        .label { text-align: center; font-size: 12px; color: #666; margin-top: 5px; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>ğŸµ å£°éŸ³ç‰©ç†å®éªŒå®¤</h1>
        <p>ç‚¹å‡»æŒ‰é’®è§£é”ï¼šè®¡ç®—å™¨å¡å†œã€é’¢ç´è°æ³¢ä¸å‚…é‡Œå¶å˜æ¢</p>
        <button id="start-btn">å¼€å¯ç”µç£ç‹‚æ¬¢</button>
    </div>

    <div class="container">
        <h1>ç”¨è®¡ç®—å™¨å¼¹ã€Šå¡å†œã€‹ï¼Ÿä¸ï¼Œè¿™æ˜¯å‚…é‡Œå¶çº§æ•°</h1>
        <p style="text-align: center; color: #666;">æ–‡ / ä½ çš„ç‰©ç†â€œå¤–æŒ‚â€</p>

        <h2>01. è®¡ç®—å™¨æ¼”å¥ (Square Wave)</h2>
        <p>è®¡ç®—å™¨å‘å‡ºçš„æ˜¯â€œæ–¹æ³¢â€ï¼Œå£°éŸ³ç”Ÿç¡¬ï¼Œåƒ 8-bit æ¸¸æˆéŸ³ä¹ã€‚</p>
        
        <div class="calc-wrapper">
            <div class="calc-screen" id="calc-display">0</div>
            <div class="calc-grid">
                <button class="btn-calc" data-note="C5">1</button>
                <button class="btn-calc" data-note="D5">2</button>
                <button class="btn-calc" data-note="E5">3</button>
                <button class="btn-calc btn-orange" onclick="playCanon()">â–¶ æ’­æ”¾å¡å†œ</button>
                
                <button class="btn-calc" data-note="F5">4</button>
                <button class="btn-calc" data-note="G5">5</button>
                <button class="btn-calc" data-note="A5">6</button>
                <button class="btn-calc btn-orange" onclick="stopAudio()">â–  åœæ­¢</button>
                
                <button class="btn-calc" data-note="B5">7</button>
                <button class="btn-calc" data-note="C6">8</button>
                <button class="btn-calc" data-note="D6">9</button>
                <button class="btn-calc" onclick="playNoise()">AC</button>
            </div>
        </div>
        <canvas id="scope-canvas"></canvas>
        <div class="label">â†‘ å®æ—¶ç¤ºæ³¢å™¨ï¼šè§‚å¯Ÿæ–¹æ³¢çš„æ£±è§’</div>

        <h2>02. é’¢ç´æ¼”å¥ (Complex Wave)</h2>
        <p>é’¢ç´åŒ…å«ä¸°å¯Œçš„â€œè°æ³¢â€ (Harmonics)ï¼Œå£°éŸ³åœ†æ¶¦ã€‚</p>
        
        <div class="piano-wrapper" id="piano-keyboard">
            </div>
        <p style="text-align: center; font-size: 14px; color: #666;">ç‚¹å‡»ç´é”®è¯•å¬ï¼Œæ³¨æ„ä¸è®¡ç®—å™¨éŸ³è‰²çš„åŒºåˆ«</p>

        <h2 style="color: #673ab7; border-color: #673ab7;">03. å‚…é‡Œå¶æ˜¾å¾®é•œ (FFT Analysis)</h2>
        <p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç”¨ç®—æ³•å°†å£°éŸ³æ‹†è§£ã€‚è¯·åˆ‡æ¢ä¸‹æ–¹æ¨¡å¼ï¼Œè§‚å¯Ÿ<strong>â€œé¢‘è°±å›¾â€</strong>çš„åŒºåˆ«ã€‚</p>

        <div class="fourier-controls">
            <button class="f-btn calc-mode active" onclick="setMode('calc')">ğŸ‘‰ å¬/çœ‹ è®¡ç®—å™¨ (æ–¹æ³¢)</button>
            <button class="f-btn piano-mode" onclick="setMode('piano')">ğŸ‘‰ å¬/çœ‹ é’¢ç´ (è°æ³¢)</button>
        </div>

        <div class="analysis-box">
            <div class="analysis-col">
                <canvas id="fft-canvas"></canvas>
                <div class="label">é¢‘åŸŸ (Spectrum)ï¼šçœ‹è°æ³¢çš„åˆ†å¸ƒ</div>
            </div>
        </div>
        <div id="analysis-text" style="background: #e1bee7; padding: 15px; border-radius: 8px; margin-top: 10px; color: #4a148c;">
            <strong>å½“å‰çŠ¶æ€ï¼š</strong> è®¡ç®—å™¨çš„é¢‘è°±åƒä¸€æ ¹æ ¹å­¤ç«‹çš„æŸ±å­ï¼ˆä¸»è¦æ˜¯å¥‡æ¬¡è°æ³¢ï¼‰ï¼Œæ‰€ä»¥å¬èµ·æ¥â€œç©ºâ€ä¸”â€œç¡¬â€ã€‚
        </div>
    </div>

    <script>
        // --- éŸ³é¢‘ä¸Šä¸‹æ–‡ä¸å…¨å±€å˜é‡ ---
        let audioCtx;
        let analyser;
        let isRunning = false;
        let currentOscillators = [];
        
        // ä¹ç†é¢‘ç‡è¡¨
        const notes = {
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
            'C6': 1046.50, 'D6': 1174.66
        };

        // --- åˆå§‹åŒ– ---
        document.getElementById('start-btn').addEventListener('click', () => {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.connect(audioCtx.destination);
            
            document.getElementById('overlay').style.display = 'none';
            isRunning = true;
            initVisualizers();
            initPianoKeys();
        });

        // --- 1. æ ¸å¿ƒå‘å£°å¼•æ“ ---
        
        // æ’­æ”¾å•éŸ³
        // type: 'square' (è®¡ç®—å™¨) æˆ– 'custom' (é’¢ç´)
        function playTone(freq, type, duration = 0.5) {
            if(!audioCtx) return;

            const gainNode = audioCtx.createGain();
            gainNode.connect(analyser);

            if (type === 'square') {
                // è®¡ç®—å™¨ï¼šçº¯æ–¹æ³¢
                const osc = audioCtx.createOscillator();
                osc.type = 'square';
                osc.frequency.value = freq;
                osc.connect(gainNode);
                
                // è®¡ç®—å™¨åŒ…ç»œï¼šå¿«é€Ÿèµ·è½
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
                currentOscillators.push(osc);
            } else {
                // é’¢ç´ï¼šåˆæˆå¤šä¸ªè°æ³¢
                const harmonics = [1, 0.5, 0.3, 0.1, 0.05]; // è°æ³¢æŒ¯å¹…é€’å‡
                harmonics.forEach((amp, index) => {
                    const osc = audioCtx.createOscillator();
                    osc.type = index % 2 === 0 ? 'sine' : 'triangle'; // æ··åˆæ³¢å½¢
                    osc.frequency.value = freq * (index + 1);
                    
                    const hGain = audioCtx.createGain();
                    hGain.gain.value = amp * 0.3; // æ€»ä½“éŸ³é‡æ§åˆ¶
                    
                    // é’¢ç´åŒ…ç»œï¼šå†²å‡»æ„Ÿ + å»¶éŸ³
                    hGain.gain.setValueAtTime(0, audioCtx.currentTime);
                    hGain.gain.linearRampToValueAtTime(amp * 0.3, audioCtx.currentTime + 0.05);
                    hGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);

                    osc.connect(hGain);
                    hGain.connect(gainNode);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 1.5);
                    currentOscillators.push(osc);
                });
            }
        }

        // --- 2. è®¡ç®—å™¨åŠŸèƒ½ ---
        
        // ç»‘å®šè®¡ç®—å™¨æŒ‰é”®
        document.querySelectorAll('.btn-calc[data-note]').forEach(btn => {
            btn.addEventListener('mousedown', () => {
                const note = btn.dataset.note;
                document.getElementById('calc-display').innerText = notes[note];
                btn.classList.add('active');
                // åœ¨è®¡ç®—å™¨æ¨¡å¼ä¸‹å‘å£°
                playTone(notes[note], 'square');
            });
            btn.addEventListener('mouseup', () => btn.classList.remove('active'));
        });

        // è‡ªåŠ¨æ¼”å¥å¡å†œ
        let canonTimeout;
        function playCanon() {
            stopAudio();
            const melody = [
                {n:'E5', d:400}, {n:'D5', d:400}, {n:'C5', d:400}, {n:'B4', d:400}, 
                {n:'A4', d:400}, {n:'G4', d:400}, {n:'A4', d:400}, {n:'B4', d:400},
                {n:'C5', d:400}, {n:'B4', d:400}, {n:'A4', d:400}, {n:'G4', d:400},
                {n:'F4', d:400}, {n:'E4', d:400}, {n:'F4', d:400}, {n:'G4', d:400} 
            ];
            
            let timeOffset = 0;
            melody.forEach((noteObj, i) => {
                canonTimeout = setTimeout(() => {
                    // é«˜äº®å¯¹åº”æŒ‰é”®
                    const btn = document.querySelector(`.btn-calc[data-note="${noteObj.n}"]`) 
                             || document.querySelector(`.btn-calc[data-note="${noteObj.n.replace('4','5')}"]`); // ç®€å•æ˜ å°„
                    if(btn) {
                        btn.classList.add('active');
                        setTimeout(()=>btn.classList.remove('active'), 200);
                    }
                    document.getElementById('calc-display').innerText = noteObj.n;
                    playTone(notes[noteObj.n], 'square', 0.3);
                }, timeOffset);
                timeOffset += noteObj.d;
            });
        }

        function stopAudio() {
            // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨å’ŒæŒ¯è¡å™¨
            let id = window.setTimeout(function() {}, 0);
            while (id--) { window.clearTimeout(id); }
            // ç®€å•é‡ç½®
            document.getElementById('calc-display').innerText = "0";
        }
        
        function playNoise() {
             playTone(100, 'square', 0.1); // æ¨¡æ‹ŸæŒ‰ACçš„æ»´å£°
             document.getElementById('calc-display').innerText = "0";
        }

        // --- 3. é’¢ç´åŠŸèƒ½ ---
        function initPianoKeys() {
            const pianoDiv = document.getElementById('piano-keyboard');
            const keys = [
                {n:'C4', c:'white'}, {n:'C#4', c:'black'}, {n:'D4', c:'white'}, {n:'D#4', c:'black'},
                {n:'E4', c:'white'}, {n:'F4', c:'white'}, {n:'F#4', c:'black'}, {n:'G4', c:'white'},
                {n:'G#4', c:'black'}, {n:'A4', c:'white'}, {n:'A#4', c:'black'}, {n:'B4', c:'white'},
                {n:'C5', c:'white'}
            ];

            keys.forEach(k => {
                const div = document.createElement('div');
                div.className = `key ${k.c}`;
                div.dataset.note = k.n;
                if(k.c === 'white') div.innerText = k.n;
                div.addEventListener('mousedown', () => {
                    playTone(notes[k.n], 'custom');
                    div.classList.add('active');
                });
                div.addEventListener('mouseup', () => div.classList.remove('active'));
                div.addEventListener('mouseleave', () => div.classList.remove('active'));
                pianoDiv.appendChild(div);
            });
        }

        // --- 4. å‚…é‡Œå¶æ¼”ç¤ºæ§åˆ¶ ---
        let demoInterval;
        function setMode(mode) {
            // åœæ­¢ä¹‹å‰çš„è‡ªåŠ¨æ¼”ç¤º
            clearInterval(demoInterval);
            
            // æ›´æ–°UI
            document.querySelectorAll('.f-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.f-btn.${mode}-mode`).classList.add('active');
            
            const text = document.getElementById('analysis-text');
            
            if (mode === 'calc') {
                text.innerHTML = "<strong>è®¡ç®—å™¨æ¨¡å¼ï¼š</strong> æ­£åœ¨ä»¥ 1Hz çš„é€Ÿåº¦è‡ªåŠ¨è§¦å‘æ–¹æ³¢ã€‚è¯·è§‚å¯Ÿä¸Šæ–¹ç»¿è‰²é¢‘è°±ï¼Œä½ ä¼šçœ‹åˆ°æ˜æ˜¾çš„å¥‡æ•°å€å³°å€¼ï¼ˆ1x, 3x, 5x...ï¼‰ï¼Œä¸­é—´æ˜¯ç©ºçš„ã€‚è¿™å°±æ˜¯å£°éŸ³åˆºè€³çš„ç‰©ç†åŸå› ã€‚";
                text.style.background = "#ffccbc"; text.style.color = "#d84315";
                
                // è‡ªåŠ¨è§¦å‘å£°éŸ³ä»¥ä¾¿è§‚å¯Ÿ
                demoInterval = setInterval(() => {
                    playTone(440, 'square', 0.8);
                }, 1000);
            } else {
                text.innerHTML = "<strong>é’¢ç´æ¨¡å¼ï¼š</strong> æ­£åœ¨è§¦å‘æ¨¡æ‹Ÿé’¢ç´å£°ã€‚è¯·è§‚å¯Ÿé¢‘è°±ï¼Œä½ ä¼šçœ‹åˆ°åŸºéŸ³åé¢è·Ÿç€ä¸€è¿ä¸²å¯†é›†çš„ã€å¹³æ»‘è¡°å‡çš„è°æ³¢ï¼ˆ1x, 2x, 3x, 4x...ï¼‰ã€‚è¿™ç§ä¸°å¯Œçš„é¢‘ç‡ç»„åˆè®©å£°éŸ³å¬èµ·æ¥æ¸©æš–ã€‚";
                text.style.background = "#bbdefb"; text.style.color = "#0d47a1";
                 // è‡ªåŠ¨è§¦å‘å£°éŸ³ä»¥ä¾¿è§‚å¯Ÿ
                demoInterval = setInterval(() => {
                    playTone(440, 'custom', 1.2);
                }, 1500);
            }
        }

        // --- 5. å¯è§†åŒ–ç»˜åˆ¶ (Canvas) ---
        function initVisualizers() {
            const scopeCtx = document.getElementById('scope-canvas').getContext('2d');
            const fftCtx = document.getElementById('fft-canvas').getContext('2d');
            
            analyser.fftSize = 2048;
            const bufferLength = analyser.frequencyBinCount;
            const timeData = new Uint8Array(bufferLength);
            const freqData = new Uint8Array(bufferLength);

            function draw() {
                requestAnimationFrame(draw);
                
                // 1. ç»˜åˆ¶æ³¢å½¢ (ç¤ºæ³¢å™¨)
                analyser.getByteTimeDomainData(timeData);
                scopeCtx.fillStyle = '#222';
                scopeCtx.fillRect(0, 0, scopeCtx.canvas.width, scopeCtx.canvas.height);
                scopeCtx.lineWidth = 2;
                scopeCtx.strokeStyle = '#00e676'; // ç»¿è‰²æ³¢å½¢
                scopeCtx.beginPath();
                
                let sliceWidth = scopeCtx.canvas.width * 1.0 / bufferLength;
                let x = 0;
                for(let i = 0; i < bufferLength; i++) {
                    let v = timeData[i] / 128.0;
                    let y = v * scopeCtx.canvas.height / 2;
                    if(i === 0) scopeCtx.moveTo(x, y);
                    else scopeCtx.lineTo(x, y);
                    x += sliceWidth;
                }
                scopeCtx.stroke();

                // 2. ç»˜åˆ¶é¢‘è°± (å‚…é‡Œå¶)
                analyser.getByteFrequencyData(freqData);
                fftCtx.fillStyle = '#222';
                fftCtx.fillRect(0, 0, fftCtx.canvas.width, fftCtx.canvas.height);
                
                const barWidth = (fftCtx.canvas.width / bufferLength) * 2.5;
                let barX = 0;
                
                for(let i = 0; i < bufferLength; i++) {
                    let barHeight = freqData[i] / 2; // ç¼©æ”¾ä¸€ä¸‹
                    // æ ¹æ®é¢‘ç‡é«˜åº¦å˜è‰²
                    fftCtx.fillStyle = `rgb(${barHeight + 100}, 50, 200)`;
                    fftCtx.fillRect(barX, fftCtx.canvas.height - barHeight, barWidth, barHeight);
                    barX += barWidth + 1;
                }
            }
            draw();
        }
    </script>
</body>
</html>